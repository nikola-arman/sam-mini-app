<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>EternalAI Studio</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--tg-theme-bg-color, #1a1a2e);
      color: var(--tg-theme-text-color, #fff);
      min-height: 100vh;
      padding: 12px;
    }
    .container { max-width: 400px; margin: 0 auto; }
    
    .upload-area {
      border: 2px dashed var(--tg-theme-hint-color, #666);
      border-radius: 16px;
      padding: 40px 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
      margin-bottom: 16px;
    }
    .upload-area:hover { border-color: var(--tg-theme-button-color, #7c3aed); }
    .upload-area.has-image { 
      padding: 8px; 
      border: 1px solid var(--tg-theme-hint-color, #333);
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .upload-area img { 
      width: 80px;
      height: 80px;
      object-fit: cover;
      border-radius: 12px;
      flex-shrink: 0;
    }
    .upload-area .change-text {
      font-size: 14px;
      color: var(--tg-theme-hint-color, #888);
    }
    .upload-area .icon { font-size: 48px; margin-bottom: 8px; }
    
    input[type="file"] { display: none; }
    
    /* Presets */
    .presets {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
      margin-bottom: 16px;
    }
    .preset-btn {
      padding: 12px 8px;
      border: 1px solid var(--tg-theme-hint-color, #333);
      border-radius: 12px;
      background: var(--tg-theme-secondary-bg-color, #16213e);
      color: var(--tg-theme-text-color, #fff);
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
      text-align: center;
    }
    .preset-btn:hover, .preset-btn.active {
      background: var(--tg-theme-button-color, #7c3aed);
      border-color: var(--tg-theme-button-color, #7c3aed);
    }
    .preset-btn .emoji { font-size: 20px; display: block; margin-bottom: 4px; }
    
    .type-toggle {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
    }
    .type-btn {
      flex: 1;
      padding: 12px;
      border: 1px solid var(--tg-theme-hint-color, #333);
      border-radius: 12px;
      background: var(--tg-theme-secondary-bg-color, #16213e);
      color: var(--tg-theme-text-color, #fff);
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .type-btn.active {
      background: var(--tg-theme-button-color, #7c3aed);
      border-color: var(--tg-theme-button-color, #7c3aed);
    }
    
    .result-area {
      margin-top: 20px;
      text-align: center;
    }
    .result-area img, .result-area video {
      max-width: 100%;
      border-radius: 16px;
    }
    
    .status {
      text-align: center;
      padding: 20px;
      color: var(--tg-theme-hint-color, #888);
    }
    .status .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid var(--tg-theme-hint-color, #333);
      border-top-color: var(--tg-theme-button-color, #7c3aed);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 12px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    
    .error { color: #ef4444; text-align: center; padding: 12px; }
    
    .result-actions {
      display: flex;
      gap: 12px;
      margin-top: 16px;
      justify-content: center;
    }
    .result-btn {
      flex: 1;
      max-width: 140px;
      padding: 12px 20px;
      border: none;
      border-radius: 12px;
      background: var(--tg-theme-button-color, #7c3aed);
      color: var(--tg-theme-button-text-color, #fff);
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    .result-btn:active { opacity: 0.8; }
    
    .job-card {
      background: var(--tg-theme-secondary-bg-color, #16213e);
      border-radius: 16px;
      padding: 16px;
      margin-bottom: 12px;
    }
    .job-header {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 12px;
      color: var(--tg-theme-hint-color, #888);
    }
    .job-card img, .job-card video {
      width: 100%;
      border-radius: 12px;
    }
    .job-card .status {
      padding: 20px 0;
    }
    .job-card .result-actions {
      margin-top: 12px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="upload-area" id="uploadArea" onclick="document.getElementById('fileInput').click()">
      <div class="icon">üì∑</div>
      <div>Tap to upload image</div>
    </div>
    <input type="file" id="fileInput" accept="image/*">
    
    <div class="type-toggle">
      <button class="type-btn active" data-type="image" onclick="setType('image')">üñºÔ∏è Image</button>
      <button class="type-btn" data-type="video" onclick="setType('video')">üé¨ Video</button>
    </div>
    
    <div class="presets" id="presets"></div>
    
    <div class="result-area" id="resultArea"></div>
  </div>

  <script>
    const API_KEY = 'sa_e5593aa4321e8f12408468cf035ddb7d4bf704a02f16cad0da651bffb341a419';
    const API_URL = 'https://open.eternalai.org';
    
    const IMAGE_PRESETS = [
      { emoji: "üî•", label: "Undress", prompt: "Make nude completely. Keep everything else unchanged" },
      { emoji: "üëô", label: "Bikini", prompt: "Change clothes to a bikini. Keep everything else unchanged." },
      { emoji: "ü©±", label: "Lingerie", prompt: "Change clothes to a lace lingerie. Keep everything else unchanged." },
      { emoji: "üê∞", label: "Bunny", prompt: "Reimagine as bunny girl cosplay, fitted bodysuit and accessories" },
      { emoji: "üõÅ", label: "Towel", prompt: "Replace clothes with small bath towel, wet skin, steamy" },
      { emoji: "üê±", label: "Catwoman", prompt: "Replace with Catwoman-inspired latex outfit" },
    ];
    
    const VIDEO_PRESETS = [
      { emoji: "üî•", label: "Undress", prompt: "The woman quickly takes off her clothes from top to bottom, show her nude body" },
      { emoji: "üçë", label: "Twerk", prompt: "The subject turns away from the viewer and twerks causing ass to jiggle and shake" },
      { emoji: "üíã", label: "Kiss", prompt: "She blows a kiss to the camera and winks" },
      { emoji: "üôà", label: "Cleavage", prompt: "Bends forward to show her cleavage, use one hand to pull and release the collar" },
      { emoji: "üíÉ", label: "Dance", prompt: "She dances sensually, moving her hips and body to music" },
      { emoji: "üòò", label: "Wink", prompt: "She winks and smiles seductively at the camera" },
    ];
    
    let selectedImage = null;
    let selectedType = 'image';
    let selectedPreset = null;
    let activeJobs = new Map(); // Track parallel generations
    
    // Initialize Telegram WebApp
    const tg = window.Telegram?.WebApp;
    if (tg) {
      tg.ready();
      tg.expand();
    }
    
    // Render presets based on current type
    function renderPresets() {
      const presets = selectedType === 'video' ? VIDEO_PRESETS : IMAGE_PRESETS;
      const container = document.getElementById('presets');
      container.innerHTML = presets.map((p, i) => `
        <button class="preset-btn" data-index="${i}" onclick="selectPreset(${i})">
          <span class="emoji">${p.emoji}</span>
          ${p.label}
        </button>
      `).join('');
    }
    renderPresets();
    
    function selectPreset(index) {
      if (!selectedImage) {
        alert('Please upload an image first');
        return;
      }
      
      const presets = selectedType === 'video' ? VIDEO_PRESETS : IMAGE_PRESETS;
      const preset = presets[index];
      const btn = document.querySelectorAll('.preset-btn')[index];
      
      // Check if already running
      if (activeJobs.has(index)) {
        return;
      }
      
      // Mark as active
      btn.classList.add('active');
      btn.style.opacity = '0.6';
      
      // Haptic feedback
      if (tg?.HapticFeedback) tg.HapticFeedback.impactOccurred('medium');
      
      // Run generation in parallel
      generatePreset(index, preset);
    }
    
    // File upload handler
    document.getElementById('fileInput').addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = (e) => {
        selectedImage = e.target.result;
        const area = document.getElementById('uploadArea');
        area.innerHTML = `
          <img src="${selectedImage}" alt="Selected">
          <span class="change-text">Tap to change image</span>
        `;
        area.classList.add('has-image');
      };
      reader.readAsDataURL(file);
    });
    
    function setType(type) {
      selectedType = type;
      document.querySelectorAll('.type-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.type === type);
      });
      renderPresets(); // Re-render presets for new type
    }
    
    async function generatePreset(index, preset) {
      const resultArea = document.getElementById('resultArea');
      const jobId = `job-${index}-${Date.now()}`;
      activeJobs.set(index, jobId);
      
      // Add result card for this job
      const jobCard = document.createElement('div');
      jobCard.id = jobId;
      jobCard.className = 'job-card';
      jobCard.innerHTML = `
        <div class="job-header">${preset.emoji} ${preset.label}</div>
        <div class="status"><div class="spinner"></div>Processing...</div>
      `;
      resultArea.prepend(jobCard);
      
      try {
        const response = await fetch(`${API_URL}/base/generate`, {
          method: 'POST',
          headers: {
            'x-api-key': API_KEY,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            images: [selectedImage],
            prompt: preset.prompt,
            type: selectedType
          })
        });
        
        const data = await response.json();
        if (!data.request_id) throw new Error('Failed to start');
        
        const result = await pollResult(data.request_id, jobId);
        
        if (result.status === 'success' && result.result_url) {
          const mediaHtml = selectedType === 'video' 
            ? `<video src="${result.result_url}" controls autoplay loop></video>`
            : `<img src="${result.result_url}" alt="Result">`;
          
          jobCard.innerHTML = `
            <div class="job-header">${preset.emoji} ${preset.label}</div>
            ${mediaHtml}
            <div class="result-actions">
              <button class="result-btn" onclick="saveResult('${result.result_url}')">üíæ Save</button>
              <button class="result-btn" onclick="shareResult('${result.result_url}')">üì§ Share</button>
            </div>
          `;
          
          if (tg?.HapticFeedback) tg.HapticFeedback.notificationOccurred('success');
        } else {
          throw new Error('Generation failed');
        }
      } catch (err) {
        jobCard.innerHTML = `
          <div class="job-header">${preset.emoji} ${preset.label}</div>
          <div class="error">‚ùå ${err.message}</div>
        `;
        if (tg?.HapticFeedback) tg.HapticFeedback.notificationOccurred('error');
      } finally {
        activeJobs.delete(index);
        const btn = document.querySelectorAll('.preset-btn')[index];
        btn.classList.remove('active');
        btn.style.opacity = '1';
      }
    }
    
    async function saveResult(url) {
      if (tg?.HapticFeedback) tg.HapticFeedback.impactOccurred('medium');
      
      try {
        const response = await fetch(url);
        const blob = await response.blob();
        const blobUrl = URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        a.href = blobUrl;
        a.download = `eternalai-${Date.now()}.${url.includes('.mp4') ? 'mp4' : 'jpg'}`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(blobUrl);
        
        if (tg?.HapticFeedback) tg.HapticFeedback.notificationOccurred('success');
      } catch (err) {
        // Fallback: open in new tab
        window.open(url, '_blank');
      }
    }
    
    async function shareResult(url) {
      if (tg?.HapticFeedback) tg.HapticFeedback.impactOccurred('medium');
      
      if (navigator.share) {
        try {
          const response = await fetch(url);
          const blob = await response.blob();
          const file = new File([blob], `eternalai.${url.includes('.mp4') ? 'mp4' : 'jpg'}`, { type: blob.type });
          
          await navigator.share({
            title: 'EternalAI Creation',
            files: [file]
          });
        } catch (err) {
          // Fallback: share URL
          try {
            await navigator.share({ url });
          } catch (e) {
            window.open(url, '_blank');
          }
        }
      } else {
        // No Web Share API - copy to clipboard
        try {
          await navigator.clipboard.writeText(url);
          alert('Link copied to clipboard!');
        } catch (e) {
          window.open(url, '_blank');
        }
      }
    }
    
    async function pollResult(requestId, jobId, maxAttempts = 60) {
      for (let i = 0; i < maxAttempts; i++) {
        await new Promise(r => setTimeout(r, 2000));
        
        const response = await fetch(`${API_URL}/poll-result/${requestId}`);
        const data = await response.json();
        
        if (data.status === 'success') return data;
        if (data.status === 'failed') throw new Error('Generation failed');
        
        // Update progress for this specific job
        if (data.progress > 0 && jobId) {
          const jobCard = document.getElementById(jobId);
          if (jobCard) {
            const statusEl = jobCard.querySelector('.status');
            if (statusEl) {
              statusEl.innerHTML = `<div class="spinner"></div>Processing... ${data.progress}%`;
            }
          }
        }
      }
      throw new Error('Timeout waiting for result');
    }
  </script>
</body>
</html>
